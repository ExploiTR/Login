package app.exploitr.login.platinum.workers;

import androidx.activity.ComponentActivity;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.lang.ref.WeakReference;
import java.util.Timer;
import java.util.TimerTask;

public class PingMonLegacy {

	private static boolean PING_CHECK = false;
	private static WeakReference<ComponentActivity> activity;
	private static WeakReference<LegacyPingListener> legacyPingListener;

	public static void requestPing(ComponentActivity appCompatActivity, LegacyPingListener listener) {
		PING_CHECK = true;
		activity = new WeakReference<>(appCompatActivity);
		legacyPingListener = new WeakReference<>(listener);

		new Thread(() -> {
			Runtime runtime = Runtime.getRuntime();
			Process process;
			try {
				process = runtime.exec("ping -i 0.5 -s 16 google.com");
			} catch (IOException e) {
				if (PING_CHECK)
					listener.onOutput(-1);
				return;
			}
			BufferedReader in;
			if (process != null) {
				in = new BufferedReader(new InputStreamReader(process.getInputStream()));
			} else {
				if (PING_CHECK)
					listener.onOutput(-1);
				return;
			}
			Timer timer = new Timer();
			timer.scheduleAtFixedRate(new TimerTask() {
				@Override
				public void run() {
					if (!PING_CHECK) {
						this.cancel();
						return;
					}
					try {
						read(appCompatActivity, listener, in);
					} catch (Exception e) {
						if (PING_CHECK)
							listener.onOutput(-1);
						this.cancel();
						e.printStackTrace();
					}
				}
			}, 0, 200);
		}).start();
	}

	public static void cancel() {
		PING_CHECK = false;
	}

	public static void resume() {
		PING_CHECK = true;
		requestPing(activity.get(), legacyPingListener.get());
	}

	private static void read(ComponentActivity activity,
							 LegacyPingListener listener, BufferedReader in) throws Exception {
		String line;
		while ((line = in.readLine()) != null) {
			if (line.contains("time")) {
				String[] parts = line.split("time=");
				String[] parts0 = parts[1].split(" ms");
				activity.runOnUiThread(() -> {
					int val = Integer.parseInt(parts0[0].split("\\.")[0]);

					if (PING_CHECK)
						listener.onOutput(val < 200 ? val : -2);
				});
			}
		}
	}

	public interface LegacyPingListener {
		void onOutput(int ping);
	}
}
