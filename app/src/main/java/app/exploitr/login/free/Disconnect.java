package app.exploitr.login.free;

import android.annotation.SuppressLint;
import android.os.AsyncTask;
import android.support.design.widget.Snackbar;
import android.view.View;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.ProgressBar;

import java.io.IOException;
import java.lang.ref.WeakReference;

import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;

class Disconnect extends AsyncTask<Void, Integer, Integer> {
	
	private WeakReference<Button> button;
	private WeakReference<ProgressBar> progressBar;
	private WeakReference<ImageView> imageView;
	private WeakReference<View> snackView;
	
	Disconnect(Button buttonM, ProgressBar progressBar, ImageView imageMView, View view) {
		this.button = new WeakReference<>(buttonM);
		this.progressBar = new WeakReference<>(progressBar);
		this.imageView = new WeakReference<>(imageMView);
		this.snackView = new WeakReference<>(view);
	}
	
	@Override
	protected void onPreExecute() {
		super.onPreExecute();
		if (button != null && button.get() != null) {
			button.get().setVisibility(View.INVISIBLE);
		}
		if (progressBar != null && progressBar.get() != null) {
			progressBar.get().setVisibility(View.VISIBLE);
		}
	}
	
	@Override
	protected Integer doInBackground(Void... params) {
		
		OkHttpClient connector = new OkHttpClient.Builder().build();
		
		Request request = new Request.Builder()
				.url("http://2.2.2.2/logout")
				.build();
		
		Response response = null;
		try {
			response = connector.newCall(request).execute();
		} catch (IOException e) {
			e.printStackTrace();
		}
		if (response != null) {
			response.close();
		}
		if (response != null && response.isSuccessful()) return 1;
		else return 0;
	}
	
	
	@SuppressLint("SetTextI18n")
	@Override
	protected void onPostExecute(Integer integer) {
		super.onPostExecute(integer);
		if (button != null && button.get() != null && progressBar != null && progressBar.get() != null) {
			button.get().setVisibility(View.VISIBLE);
			progressBar.get().setVisibility(View.INVISIBLE);
			System.out.println("Logout finished");
			if (integer == 0) {
				imageView.get().setImageResource(R.drawable.isconnected);
				button.get().setText("Logout");
				Snackbar.make(snackView.get(), "Logout Unsuccessful", Snackbar.LENGTH_SHORT).show();
			} else {
				imageView.get().setImageResource(R.drawable.isconnectedx);
				button.get().setText("Login");
				Snackbar.make(snackView.get(), "Successfully Logged Out", Snackbar.LENGTH_SHORT).show();
			}
		}
	}
	
}

